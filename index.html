<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üçÖ Minimal Timer</title>
    <style>
        :root {
            --primary: #3A86FF;
            --primary-light: #8BB8FF;
            --primary-dark: #2A66CC;
            --secondary: #FF006E;
            --secondary-light: #FF5CA8;
            --accent: #8338EC;
            --success: #38B000;
            --text: #2D3748;
            --text-light: #718096;
            --bg: #FAFBFC;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 8px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px 25px;
            border: 1px solid var(--border);
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
        .header p { color: var(--text-light); font-size: 15px; }
        .settings-btn {
            position: absolute; top:0; right:0;
            width:36px; height:36px; border-radius:50%;
            background:var(--bg); border:1px solid var(--border);
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; color:var(--text-light); transition:all .2s;
        }
        .settings-btn:hover { background:var(--primary); color:white; transform:rotate(30deg); }

        .timer-display {
            font-family: 'SF Mono', monospace;
            font-size: 60px; font-weight:300; text-align:center;
            margin:15px 0; letter-spacing:-2px;
        }
        .progress-container { height:4px; background:var(--border); border-radius:2px; margin:20px 0; overflow:hidden; }
        .progress-bar { height:100%; background:linear-gradient(90deg,var(--primary),var(--accent)); width:0%; transition:width .5s ease; }

        .mode-indicator {
            text-align:center; font-size:16px; font-weight:600; margin:15px 0;
            padding:10px 20px; border-radius:50px; display:inline-block;
            margin-left:50%; transform:translateX(-50%);
        }
        .mode-indicator:not(.break) { background:rgba(58,134,255,.08); color:var(--primary); }
        .mode-indicator.break { background:rgba(255,0,110,.08); color:var(--secondary); }

        .mode-selector { display:flex; gap:10px; margin:20px 0; justify-content:center; }
        .mode-btn {
            padding:12px 24px; border:2px solid var(--border); border-radius:var(--radius-sm);
            font-size:14px; font-weight:500; cursor:pointer; transition:all .2s;
            flex:1; max-width:180px; background:var(--card); color:var(--text);
            display:flex; align-items:center; justify-content:center; gap:6px;
        }
        .mode-btn:hover { transform:translateY(-1px); box-shadow:var(--shadow); }
        .mode-btn.active { background:var(--primary); color:white; border-color:var(--primary); }
        .mode-btn.break.active { background:var(--secondary); color:white; border-color:var(--secondary); }

        .current-task {
            padding:16px; background:rgba(58,134,255,.08); border-radius:var(--radius-sm);
            border:1px solid rgba(58,134,255,.2); font-weight:500; font-size:14px;
            display:flex; align-items:center; justify-content:space-between;
        }
        .current-task.empty {
            background:rgba(113,128,150,.05); border:1px solid var(--border);
            color:var(--text-light); text-align:center; display:block; padding:14px;
        }

        .controls { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin:25px 0 20px; }
        .control-btn {
            padding:14px; border:none; border-radius:var(--radius-sm);
            font-size:14px; font-weight:500; cursor:pointer; transition:all .2s;
            display:flex; align-items:center; justify-content:center; gap:6px;
        }
        .control-btn.start { background:var(--primary); color:white; }
        .control-btn.start:hover { background:var(--primary-dark); }
        .control-btn.pause { background:rgba(113,128,150,.1); color:var(--text); }
        .control-btn.pause:hover { background:rgba(113,128,150,.2); }
        .control-btn.reset { background:none; color:var(--text); border:2px solid var(--border); }
        .control-btn.reset:hover { border-color:var(--text-light); }

        .section-title { font-size:16px; font-weight:600; margin-bottom:15px; display:flex; align-items:center; gap:8px; }
        .section-title i { color:var(--primary); font-size:14px; }

        .task-input-container { display:flex; gap:10px; margin-bottom:15px; align-items:flex-end; }
        .task-input { flex:1; padding:12px 15px; border:2px solid var(--border); border-radius:var(--radius-sm); font-size:14px; }
        .task-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(58,134,255,.1); }
        .intervals-input { width:100px; padding:12px; border:2px solid var(--border); border-radius:var(--radius-sm); text-align:center; }
        .add-btn {
            background:var(--primary); color:white; border:none; border-radius:var(--radius-sm);
            padding:0 20px; cursor:pointer; font-weight:500; height:44px;
        }

        .task-progress { margin:15px 0; padding:12px; background:rgba(58,134,255,.05); border-radius:var(--radius-sm); border:1px solid rgba(58,134,255,.2); display:flex; justify-content:space-between; align-items:center; }
        .task-progress-count { color:var(--primary); font-weight:700; background:rgba(58,134,255,.1); padding:4px 10px; border-radius:10px; }

        .task-list { max-height:180px; overflow-y:auto; border:1px solid var(--border); border-radius:var(--radius-sm); }
        .task-item {
            padding:14px 16px; border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:12px; transition:all .2s;
        }
        .task-item:hover { background:rgba(58,134,255,.03); }
        .task-item:last-child { border-bottom:none; }
        .task-item.active { background:rgba(58,134,255,.08); border-left:3px solid var(--primary); }

        .task-checkbox {
            width:18px; height:18px; border:2px solid var(--border); border-radius:5px;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        .task-checkbox.checked { background:var(--success); border-color:var(--success); }
        .task-checkbox.checked::after { content:'‚úì'; color:white; font-size:11px; font-weight:bold; }

        .task-text.completed { text-decoration:line-through; color:var(--text-light); opacity:.7; }
        .task-intervals-badge {
            color:var(--primary); font-weight:600; font-size:12px;
            background:rgba(58,134,255,.1); padding:3px 8px; border-radius:10px;
        }

        .sound-controls { margin:20px 0; background:rgba(58,134,255,.03); padding:16px; border-radius:var(--radius-sm); border:1px solid var(--border); }
        .sound-buttons { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:12px; }
        .sound-btn {
            padding:10px; border:2px solid var(--border); border-radius:var(--radius-sm);
            background:var(--card); color:var(--text); cursor:pointer;
            display:flex; flex-direction:column; align-items:center; min-height:70px;
        }
        .sound-btn.active { background:var(--primary); color:white; border-color:var(--primary); }

        .stats { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin:20px 0; padding:16px; background:rgba(58,134,255,.03); border-radius:var(--radius-sm); }
        .stat-value { font-size:20px; font-weight:700; color:var(--primary); }

        .settings-modal {
            position:fixed; inset:0; background:rgba(0,0,0,.5);
            display:flex; align-items:center; justify-content:center; z-index:1000;
            opacity:0; visibility:hidden; transition:all .3s;
        }
        .settings-modal.active { opacity:1; visibility:visible; }
        .settings-content {
            background:var(--card); border-radius:var(--radius); padding:30px;
            width:90%; max-width:400px; box-shadow:var(--shadow-lg);
        }
        .settings-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; }
        .setting-item.full-width { grid-column:span 2; }
        .setting-input {
            width:100%; padding:10px; border:2px solid var(--border); border-radius:var(--radius-sm);
            text-align:center; font-size:15px; font-weight:600; color:var(--primary);
        }
        .settings-save { width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:var(--radius-sm); font-size:15px; cursor:pointer; }

        .local-notification {
            position:fixed; top:20px; right:20px; width:300px; z-index:9999;
            background:var(--card); border-radius:var(--radius-sm); box-shadow:var(--shadow-lg);
            padding:16px; transform:translateX(120%); transition:transform .3s ease;
            border-left:4px solid var(--primary);
        }
        .local-notification.show { transform:translateX(0); }

        @media (max-width:540px) {
            .container { padding:25px 20px; }
            .timer-display { font-size:52px; }
            .mode-selector { flex-direction:column; }
            .mode-btn { max-width:100%; }
            .sound-buttons { grid-template-columns:repeat(2,1fr); }
            .settings-grid { grid-template-columns:1fr; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Minimal Timer</h1>
        <p>–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤–∞–∂–Ω–æ–º</p>
        <button class="settings-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
    </div>

    <div class="timer-section">
        <div class="timer-display" id="display">25:00</div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="mode-indicator" id="modeIndicator">–†–∞–±–æ—Ç–∞</div>

        <div class="mode-selector">
            <button class="mode-btn active" id="workModeBtn"><i class="fas fa-briefcase"></i> –†–∞–±–æ—Ç–∞</button>
            <button class="mode-btn break" id="breakModeBtn"><i class="fas fa-coffee"></i> –û—Ç–¥—ã—Ö</button>
        </div>
    </div>

    <div class="current-task-section">
        <div class="current-task empty" id="currentTaskDisplay">–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
    </div>

    <div class="controls">
        <button class="control-btn start" id="startBtn"><i class="fas fa-play"></i> –°—Ç–∞—Ä—Ç</button>
        <button class="control-btn pause" id="pauseBtn"><i class="fas fa-pause"></i> –ü–∞—É–∑–∞</button>
        <button class="control-btn reset" id="resetBtn"><i class="fas fa-redo"></i> –°–±—Ä–æ—Å</button>
    </div>

    <div class="tasks-section">
        <div class="section-title"><i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏</div>

        <div class="task-input-container">
            <input type="text" class="task-input" id="taskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞...">
            <div class="intervals-container">
                <div class="intervals-label">–ü–æ–º–∏–¥–æ—Ä–æ–∫</div>
                <input type="number" class="intervals-input" id="taskIntervals" value="1" min="1" max="10">
            </div>
            <button class="add-btn" id="addTaskBtn">+</button>
        </div>

        <div class="task-progress" id="taskProgress" style="display:none;">
            <div class="task-progress-text">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:</div>
            <div class="task-progress-count" id="completedIntervalsDisplay">0/1</div>
        </div>

        <div class="task-list" id="taskList"></div>
    </div>

    <div class="sound-controls">
        <div class="sound-title"><i class="fas fa-music"></i> –§–æ–Ω</div>
        <div class="sound-buttons" id="soundButtons">
            <button class="sound-btn" data-sound="lofi"><i class="fas fa-headphones"></i> Lofi</button>
            <button class="sound-btn" data-sound="rain"><i class="fas fa-cloud-rain"></i> –î–æ–∂–¥—å</button>
            <button class="sound-btn" data-sound="forest"><i class="fas fa-tree"></i> –õ–µ—Å</button>
            <button class="sound-btn active" data-sound="none"><i class="fas fa-volume-mute"></i> –í—ã–∫–ª</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-item"><div class="stat-value" id="completedSessions">0</div><div class="stat-label">–°–µ—Å—Å–∏–π</div></div>
        <div class="stat-item"><div class="stat-value" id="totalTime">0</div><div class="stat-label">–ú–∏–Ω—É—Ç</div></div>
        <div class="stat-item"><div class="stat-value" id="tasksCompleted">0</div><div class="stat-label">–ó–∞–¥–∞—á</div></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div class="settings-modal" id="settingsModal">
    <div class="settings-content">
        <div class="settings-header">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="close-btn" id="closeSettings"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-grid">
            <div class="setting-item">
                <label class="setting-label">–†–∞–±–æ—Ç–∞ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="workDuration" value="25" min="1" max="60">
            </div>
            <div class="setting-item">
                <label class="setting-label">–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="shortBreakDuration" value="5" min="1" max="30">
            </div>
            <div class="setting-item">
                <label class="setting-label">–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="longBreakDuration" value="15" min="1" max="60">
            </div>
            <div class="setting-item">
                <label class="setting-label">–°–µ—Å—Å–∏–π –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ</label>
                <input type="number" class="setting-input" id="sessionsUntilLongBreak" value="4" min="1" max="10">
            </div>
            <div class="setting-item full-width">
                <label class="setting-label">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="currentProgressDisplay">0/4</span></label>
                <div class="progress-container" style="height:6px;margin:8px 0;">
                    <div class="progress-bar" id="longBreakProgressBar"></div>
                </div>
            </div>
        </div>
        <button class="settings-save" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div class="local-notification" id="localNotification">
    <div class="notification-title" id="notificationTitle">–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</div>
    <div class="notification-message" id="notificationMessage"></div>
    <div class="notification-buttons">
        <button class="notification-btn start" id="notificationStartBtn">–ù–∞—á–∞—Ç—å</button>
        <button class="notification-btn later" id="notificationLaterBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- –ó–≤—É–∫–∏ -->
<audio id="alert-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
</audio>

<audio id="lofi-track" loop preload="none">
    <source src="https://cdn.pixabay.com/audio/2023/08/07/audio_8b0e3e8d3d.mp3" type="audio/mpeg">
</audio>
<audio id="rain-track" loop preload="none">
    <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_9e0e3e8d3d.mp3" type="audio/mpeg">
</audio>
<audio id="forest-track" loop preload="none">
    <source src="https://cdn.pixabay.com/audio/2022/05/25/audio_f3b2c1e8d3.mp3" type="audio/mpeg">
</audio>

<script>
// =============================================================================
// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
// =============================================================================
const WORK_MODE = 'work';
const BREAK_SHORT_MODE = 'shortBreak';
const BREAK_LONG_MODE = 'longBreak';

let mode = WORK_MODE;
let isRunning = false;
let timerId = null;
let endTime = null;
let sessionsCompleted = 0;
let tasksCompleted = 0;
let totalTimeWorked = 0;
let tasks = [];
let currentTaskIndex = -1;
let sessionsUntilLongBreak = 4;

let currentTaskIntervalsCompleted = 0;
let currentTaskTotalIntervals = 1;

let currentSoundCategory = 'none';
let isSoundPlaying = false;
let notificationPermission = false;

// =============================================================================
// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
// =============================================================================
const display = document.getElementById('display');
const progressBar = document.getElementById('progressBar');
const modeIndicator = document.getElementById('modeIndicator');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const workModeBtn = document.getElementById('workModeBtn');
const breakModeBtn = document.getElementById('breakModeBtn');
const workDurationInput = document.getElementById('workDuration');
const shortBreakInput = document.getElementById('shortBreakDuration');
const longBreakInput = document.getElementById('longBreakDuration');
const sessionsUntilLongBreakInput = document.getElementById('sessionsUntilLongBreak');
const currentProgressDisplay = document.getElementById('currentProgressDisplay');
const longBreakProgressBar = document.getElementById('longBreakProgressBar');
const taskInput = document.getElementById('taskInput');
const taskIntervalsInput = document.getElementById('taskIntervals');
const addTaskBtn = document.getElementById('addTaskBtn');
const taskListEl = document.getElementById('taskList');
const currentTaskDisplay = document.getElementById('currentTaskDisplay');
const completedSessionsEl = document.getElementById('completedSessions');
const totalTimeEl = document.getElementById('totalTime');
const tasksCompletedEl = document.getElementById('tasksCompleted');
const taskProgressEl = document.getElementById('taskProgress');
const completedIntervalsDisplay = document.getElementById('completedIntervalsDisplay');

const localNotification = document.getElementById('localNotification');
const notificationTitle = document.getElementById('notificationTitle');
const notificationMessage = document.getElementById('notificationMessage');
const notificationStartBtn = document.getElementById('notificationStartBtn');
const notificationLaterBtn = document.getElementById('notificationLaterBtn');

const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const saveSettingsBtn = document.getElementById('saveSettings');

// =============================================================================
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// =============================================================================
resetTimer();
checkNotificationPermission();
updateModeButtons();
updateLongBreakProgress();

// =============================================================================
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
// =============================================================================
startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);
workModeBtn.addEventListener('click', () => setMode(WORK_MODE));
breakModeBtn.addEventListener('click', () => setMode(BREAK_SHORT_MODE));
addTaskBtn.addEventListener('click', addTask);
taskInput.addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });
notificationStartBtn.addEventListener('click', startFromNotification);
notificationLaterBtn.addEventListener('click', hideLocalNotification);
settingsBtn.addEventListener('click', () => {
    updateLongBreakProgress();
    settingsModal.classList.add('active');
});
closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
saveSettingsBtn.addEventListener('click', saveSettingsHandler);

document.querySelectorAll('.sound-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        setSoundCategory(btn.dataset.sound);
        document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});

workDurationInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
shortBreakInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
longBreakInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
sessionsUntilLongBreakInput.addEventListener('input', updateLongBreakSettings);

// =============================================================================
// –¢–∞–π–º–µ—Ä
// =============================================================================
function getDuration() {
    if (mode === WORK_MODE) return Number(workDurationInput.value) * 60 || 1500;
    if (mode === BREAK_SHORT_MODE) return Number(shortBreakInput.value) * 60 || 300;
    if (mode === BREAK_LONG_MODE) return Number(longBreakInput.value) * 60 || 900;
    return 1500;
}

function setMode(newMode) {
    if (isRunning) pauseTimer();
    mode = (newMode === BREAK_LONG_MODE || newMode === BREAK_SHORT_MODE) ? newMode : WORK_MODE;
    resetTimer();
    updateModeIndicator();
    updateModeButtons();
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
}

function startTimer() {
    if (isRunning) return;
    isRunning = true;
    endTime = Date.now() + getDuration() * 1000;

    startBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${mode === WORK_MODE ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' : '–û—Ç–¥—ã—Ö'}`;
    startBtn.disabled = true;

    if (currentSoundCategory !== 'none' && !isSoundPlaying) playBackgroundSound();

    tick();
    timerId = setInterval(tick, 980);
}

function tick() {
    if (!isRunning) return;
    const remainingMs = Math.max(0, endTime - Date.now());
    const remaining = Math.round(remainingMs / 1000);

    updateDisplay(remaining);
    updateProgressBar((getDuration() - remaining) / getDuration() * 100);

    if (mode === WORK_MODE) {
        const minWorked = Math.floor((getDuration() - remaining) / 60);
        if (minWorked > totalTimeWorked) {
            totalTimeWorked = minWorked;
            updateStats();
        }
    }

    if (remainingMs <= 0) handleSessionEnd();
}

function pauseTimer() {
    if (!isRunning) return;
    isRunning = false;
    clearInterval(timerId);
    timerId = null;
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–¥—ã—Ö'}`;
    startBtn.disabled = false;
}

function resetTimer() {
    pauseTimer();
    endTime = Date.now() + getDuration() * 1000;
    updateDisplay(getDuration());
    updateProgressBar(0);
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
    startBtn.disabled = false;
}

function handleSessionEnd() {
    clearInterval(timerId);
    timerId = null;
    isRunning = false;

    playAlertSound();

    if (mode === WORK_MODE) {
        sessionsCompleted++;
        currentTaskIntervalsCompleted++;
        updateTaskProgress();
        updateLongBreakProgress();

        if (isSoundPlaying) pauseBackgroundSound();

        const needed = Number(sessionsUntilLongBreakInput.value) || 4;
        const isLong = sessionsCompleted % needed === 0;

        showNotification(
            isLong ? '–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤!' : '–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤',
            isLong
                ? `–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ ${longBreakInput.value} –º–∏–Ω—É—Ç. –û—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏!`
                : `–ü–µ—Ä–µ—Ä—ã–≤. –î–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å ${needed - (sessionsCompleted % needed)} —Å–µ—Å—Å–∏–π.`,
            'break'
        );

        setTimeout(() => setMode(isLong ? BREAK_LONG_MODE : BREAK_SHORT_MODE), 800);
    } else {
        showNotification(
            '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å!',
            '–ü–µ—Ä–µ—Ä—ã–≤ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∑–∞–¥–∞—á–µ.',
            'work'
        );
        setTimeout(() => setMode(WORK_MODE), 800);
    }

    startBtn.disabled = false;
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
}

// =============================================================================
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
// =============================================================================
function showNotification(title, msg, type = 'info') {
    notificationTitle.textContent = title;
    notificationMessage.textContent = msg;
    localNotification.classList.add('show');

    if (type === 'break') modeIndicator.classList.add('break');
    else modeIndicator.classList.remove('break');

    setTimeout(() => localNotification.classList.remove('show'), 10000);

    if (notificationPermission) {
        new Notification(title, { body: msg });
    }
}

function hideLocalNotification() {
    localNotification.classList.remove('show');
}

function startFromNotification() {
    hideLocalNotification();
    startTimer();
}

// =============================================================================
// –ó–≤—É–∫–∏
// =============================================================================
function playAlertSound() {
    const snd = document.getElementById('alert-sound');
    snd.currentTime = 0;
    snd.volume = 0.7;
    snd.play().catch(e => console.log("–ó–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω", e));
}

function playBackgroundSound() {
    stopAllBackgroundSounds();
    const audio = document.getElementById(currentSoundCategory + '-track');
    if (audio) {
        audio.volume = 0.3;
        audio.play().catch(() => {});
        isSoundPlaying = true;
    }
}

function pauseBackgroundSound() {
    const audio = document.getElementById(currentSoundCategory + '-track');
    if (audio) {
        audio.pause();
        isSoundPlaying = false;
    }
}

function stopAllBackgroundSounds() {
    ['lofi','rain','forest'].forEach(s => {
        const a = document.getElementById(s + '-track');
        if (a) { a.pause(); a.currentTime = 0; }
    });
    isSoundPlaying = false;
}

function setSoundCategory(cat) {
    pauseBackgroundSound();
    currentSoundCategory = cat;
    if (isRunning && cat !== 'none') playBackgroundSound();
}

// =============================================================================
// –ó–∞–¥–∞—á–∏
// =============================================================================
function addTask() {
    const text = taskInput.value.trim();
    const intervals = Number(taskIntervalsInput.value) || 1;
    if (!text) return;

    const task = {
        id: Date.now(),
        text,
        intervals,
        completedIntervals: 0,
        completed: false
    };

    tasks.push(task);
    renderTaskList();
    taskInput.value = '';
    taskInput.focus();

    if (currentTaskIndex === -1) selectTask(tasks.length - 1);
}

function renderTaskList() {
    taskListEl.innerHTML = '';

    if (tasks.length === 0) {
        taskListEl.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-light);">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        return;
    }

    tasks.forEach((task, i) => {
        const item = document.createElement('div');
        item.className = `task-item ${i === currentTaskIndex ? 'active' : ''}`;

        item.innerHTML = `
            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTaskCompletion(${task.id})"></div>
            <div class="task-content">
                <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                <div class="task-intervals-badge">${task.completedIntervals}/${task.intervals}</div>
            </div>
            <div class="task-actions">
                <button class="task-btn delete" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;

        item.addEventListener('click', e => {
            if (!e.target.closest('.task-checkbox') && !e.target.closest('.task-btn')) {
                selectTask(i);
            }
        });

        taskListEl.appendChild(item);
    });
}

window.toggleTaskCompletion = function(id) {
    const idx = tasks.findIndex(t => t.id === id);
    if (idx === -1) return;

    tasks[idx].completed = !tasks[idx].completed;
    if (tasks[idx].completed) tasksCompleted++;
    else tasksCompleted--;

    updateStats();
    renderTaskList();

    if (idx === currentTaskIndex && tasks[idx].completed) {
        const next = findNextIncompleteTask();
        if (next !== -1) selectTask(next);
    }
};

window.deleteTask = function(id) {
    const idx = tasks.findIndex(t => t.id === id);
    if (idx === -1) return;

    if (tasks[idx].completed) tasksCompleted--;
    if (idx === currentTaskIndex) {
        const next = findNextIncompleteTask(idx);
        tasks.splice(idx, 1);
        if (next !== -1) selectTask(next < tasks.length ? next : tasks.length - 1);
        else currentTaskIndex = -1;
    } else {
        tasks.splice(idx, 1);
        if (currentTaskIndex > idx) currentTaskIndex--;
    }

    renderTaskList();
    updateStats();

    if (currentTaskIndex === -1) {
        currentTaskDisplay.classList.add('empty');
        currentTaskDisplay.textContent = '–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        taskProgressEl.style.display = 'none';
    }
};

function selectTask(index) {
    if (index < 0 || index >= tasks.length) return;
    currentTaskIndex = index;
    const t = tasks[index];

    currentTaskDisplay.innerHTML = `${t.text} <span class="task-intervals">${t.completedIntervals}/${t.intervals}</span>`;
    currentTaskDisplay.classList.remove('empty');

    currentTaskIntervalsCompleted = t.completedIntervals;
    currentTaskTotalIntervals = t.intervals;
    updateTaskProgress();
    taskProgressEl.style.display = 'flex';

    document.querySelectorAll('.task-item').forEach((el,i) => el.classList.toggle('active', i === index));
}

function updateTaskProgress() {
    completedIntervalsDisplay.textContent = `${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}`;

    if (currentTaskIndex === -1) return;

    tasks[currentTaskIndex].completedIntervals = currentTaskIntervalsCompleted;

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –≤ —Å–ø–∏—Å–∫–µ
    const items = taskListEl.querySelectorAll('.task-item');
    if (items[currentTaskIndex]) {
        const badge = items[currentTaskIndex].querySelector('.task-intervals-badge');
        if (badge) badge.textContent = `${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}`;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É —Å–≤–µ—Ä—Ö—É
    if (!currentTaskDisplay.classList.contains('empty')) {
        currentTaskDisplay.innerHTML = `${tasks[currentTaskIndex].text} <span class="task-intervals">${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}</span>`;
    }

    if (currentTaskIntervalsCompleted >= currentTaskTotalIntervals) {
        tasks[currentTaskIndex].completed = true;
        tasksCompleted++;
        updateStats();
        renderTaskList();

        const next = findNextIncompleteTask();
        if (next !== -1) selectTask(next);
        else {
            currentTaskIndex = -1;
            currentTaskDisplay.classList.add('empty');
            currentTaskDisplay.textContent = '–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            taskProgressEl.style.display = 'none';
        }
    }
}

function findNextIncompleteTask(start = 0) {
    for (let i = start; i < tasks.length; i++) {
        if (!tasks[i].completed) return i;
    }
    for (let i = 0; i < start; i++) {
        if (!tasks[i].completed) return i;
    }
    return -1;
}

// =============================================================================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// =============================================================================
function updateDisplay(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    display.textContent = `${m}:${s}`;
}

function updateProgressBar(percent) {
    progressBar.style.width = `${percent}%`;
}

function updateModeIndicator() {
    modeIndicator.textContent = mode === WORK_MODE ? '–†–∞–±–æ—Ç–∞' : '–ü–µ—Ä–µ—Ä—ã–≤';
    modeIndicator.classList.toggle('break', mode !== WORK_MODE);
}

function updateModeButtons() {
    workModeBtn.classList.toggle('active', mode === WORK_MODE);
    breakModeBtn.classList.toggle('active', mode !== WORK_MODE);
}

function updateStats() {
    completedSessionsEl.textContent = sessionsCompleted;
    totalTimeEl.textContent = totalTimeWorked;
    tasksCompletedEl.textContent = tasksCompleted;
}

function checkNotificationPermission() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
        notificationPermission = true;
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(perm => {
            notificationPermission = perm === "granted";
        });
    }
}

function updateLongBreakProgress() {
    const needed = Number(sessionsUntilLongBreakInput.value) || 4;
    const progress = sessionsCompleted % needed;
    currentProgressDisplay.textContent = `${progress}/${needed}`;
    longBreakProgressBar.style.width = `${(progress / needed) * 100}%`;
}

function updateLongBreakSettings() {
    sessionsUntilLongBreak = Number(sessionsUntilLongBreakInput.value) || 4;
    updateLongBreakProgress();
}

function saveSettingsHandler() {
    updateLongBreakSettings();
    settingsModal.classList.remove('active');
    if (!isRunning) resetTimer();
}

// =============================================================================
// –°—Ç–∞—Ä—Ç
// =============================================================================
renderTaskList();
</script>
</body>
</html>
