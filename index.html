<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçÖ Pomodoro Flow</title>
    <style>
        :root {
            --primary: #8B5CF6;
            --primary-light: #A78BFA;
            --primary-dark: #7C3AED;
            --secondary: #10B981;
            --secondary-light: #34D399;
            --accent: #F59E0B;
            --danger: #EF4444;
            --gradient-bg: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            --card-bg: rgba(30, 41, 59, 0.8);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #F1F5F9;
            --text-light: #94A3B8;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
            --radius: 20px;
            --radius-sm: 12px;
            --glass: rgba(255, 255, 255, 0.05);
          
            /* –¶–≤–µ—Ç–∞ —Ç–µ–≥–æ–≤ –∑–∞–¥–∞—á */
            --important-urgent: #EF4444; /* –ö—Ä–∞—Å–Ω—ã–π - –í–∞–∂–Ω–æ-–°—Ä–æ—á–Ω–æ */
            --important-not-urgent: #10B981; /* –ó–µ–ª–µ–Ω—ã–π - –í–∞–∂–Ω–æ-–ù–µ—Å—Ä–æ—á–Ω–æ */
            --not-important-urgent: #F59E0B; /* –ñ–µ–ª—Ç—ã–π - –ù–µ–≤–∞–∂–Ω–æ-–°—Ä–æ—á–Ω–æ */
            --not-important-not-urgent: #8B5CF6; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π - –ù–µ–≤–∞–∂–Ω–æ-–ù–µ—Å—Ä–æ—á–Ω–æ */
        }
      
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
      
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
      
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
            z-index: -1;
        }
      
        .container {
            max-width: 500px;
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
      
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            border-radius: var(--radius) var(--radius) 0 0;
        }
      
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
      
        .header h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--secondary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
      
        .header p {
            color: var(--text-light);
            font-size: 15px;
            font-weight: 400;
        }
      
        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
      
        .settings-btn:hover {
            background: var(--primary);
            color: white;
            transform: rotate(90deg);
            border-color: var(--primary);
        }
      
        .timer-section {
            position: relative;
            margin-bottom: 30px;
        }
      
        .timer-display {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 72px;
            font-weight: 300;
            text-align: center;
            margin: 20px 0;
            letter-spacing: -3px;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            display: inline-block;
            width: 100%;
        }
      
        .timer-display::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-light), transparent);
        }
      
        .progress-ring {
            width: 220px;
            height: 220px;
            margin: 0 auto 25px;
            position: relative;
        }
      
        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease;
        }
      
        .progress-ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }
      
        .progress-ring-fill {
            stroke: url(#gradient);
        }
      
        .mode-indicator {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0;
            padding: 12px 30px;
            border-radius: 50px;
            display: inline-block;
            margin-left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
        }
      
        .mode-indicator.work {
            color: var(--primary-light);
            border-color: rgba(139, 92, 246, 0.3);
        }
      
        .mode-indicator.break {
            color: var(--secondary-light);
            border-color: rgba(16, 185, 129, 0.3);
        }
      
        .mode-selector {
            display: flex;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
      
        .mode-btn {
            padding: 14px 28px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 180px;
            background: var(--glass);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
      
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
      
        .mode-btn:hover::before {
            left: 100%;
        }
      
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
      
        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: transparent;
        }
      
        .mode-btn.break.active {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
        }
      
        .current-task {
            padding: 18px;
            background: var(--glass);
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            font-weight: 500;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
      
        .current-task:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-1px);
        }
      
        .current-task.empty {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            text-align: center;
            display: block;
            padding: 16px;
        }
      
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 30px 0 25px;
        }
      
        .control-btn {
            padding: 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
      
        .control-btn.start {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
      
        .control-btn.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
      
        .control-btn.pause {
            background: var(--glass);
            color: var(--text);
            border: 1px solid var(--card-border);
        }
      
        .control-btn.pause:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
      
        .control-btn.reset {
            background: transparent;
            color: var(--text-light);
            border: 2px solid var(--card-border);
        }
      
        .control-btn.reset:hover {
            border-color: var(--text-light);
            color: var(--text);
            transform: translateY(-2px);
        }
      
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }
      
        .section-title i {
            color: var(--primary);
            font-size: 14px;
        }
      
        .task-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
      
        .task-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--glass);
            color: var(--text);
            transition: all 0.3s ease;
        }
      
        .task-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }
      
        .intervals-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }
      
        .intervals-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            text-align: center;
            background: var(--glass);
            color: var(--text);
            font-size: 14px;
        }
      
        .intervals-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
            text-align: center;
            width: 100%;
        }
      
        .add-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0 24px;
            cursor: pointer;
            font-weight: 600;
            height: 48px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
      
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
      
        .task-progress {
            margin: 15px 0;
            padding: 14px;
            background: var(--glass);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(139, 92, 246, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
      
        .task-progress-count {
            color: var(--primary-light);
            font-weight: 700;
            background: rgba(139, 92, 246, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
        }
      
        .task-list {
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: rgba(15, 23, 42, 0.5);
            margin-bottom: 20px;
            min-height: 60px;
            overflow: visible;
        }
      
        .task-item {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: flex-start;
            gap: 14px;
            transition: all 0.3s ease;
            cursor: grab;
            position: relative;
        }
      
        .task-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
      
        .task-item:last-child {
            border-bottom: none;
        }
      
        .task-item.active {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--primary);
        }
      
        .task-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            border: 2px dashed var(--primary);
        }
      
        .drag-handle {
            cursor: grab;
            color: var(--text-light);
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
      
        .drag-handle:hover {
            color: var(--primary);
        }
      
        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--card-border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-top: 2px;
        }
      
        .task-checkbox:hover {
            border-color: var(--primary);
        }
      
        .task-checkbox.checked {
            background: var(--secondary);
            border-color: var(--secondary);
        }
      
        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
      
        .task-content {
            flex: 1;
            min-width: 0;
        }
      
        .task-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-word;
        }
      
        .task-text.completed {
            text-decoration: line-through;
            color: var(--text-light);
            opacity: 0.7;
        }
      
        .task-comment {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            display: none;
        }
      
        .task-comment.show {
            display: block;
        }
      
        .task-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
      
        .task-intervals-badge {
            color: var(--primary-light);
            font-weight: 600;
            font-size: 12px;
            background: rgba(139, 92, 246, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
        }
      
        .task-tag {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-light);
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
      
        .task-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
      
        .task-tag.active {
            border: 2px solid white;
            transform: scale(1.05);
        }
      
        .task-tag.important-urgent {
            background: rgba(239, 68, 68, 0.15);
            color: #FCA5A5;
        }
      
        .task-tag.important-not-urgent {
            background: rgba(16, 185, 129, 0.15);
            color: #A7F3D0;
        }
      
        .task-tag.not-important-urgent {
            background: rgba(245, 158, 11, 0.15);
            color: #FDE68A;
        }
      
        .task-tag.not-important-not-urgent {
            background: rgba(139, 92, 246, 0.15);
            color: #C4B5FD;
        }
      
        .task-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
      
        .task-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
      
        .task-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
      
        .task-btn.comment-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent);
        }
      
        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ */
        .tag-selector {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
      
        .tag-selector-btn {
            padding: 8px 16px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
      
        .tag-selector-btn:hover {
            transform: translateY(-1px);
        }
      
        .tag-selector-btn.active {
            border-color: transparent;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
      
        .tag-selector-btn.important-urgent.active {
            background: linear-gradient(135deg, var(--important-urgent), #FF6B6B);
            color: white;
        }
      
        .tag-selector-btn.important-not-urgent.active {
            background: linear-gradient(135deg, var(--important-not-urgent), #4ECDC4);
            color: white;
        }
      
        .tag-selector-btn.not-important-urgent.active {
            background: linear-gradient(135deg, var(--not-important-urgent), #FFD166);
            color: #1E293B;
        }
      
        .tag-selector-btn.not-important-not-urgent.active {
            background: linear-gradient(135deg, var(--not-important-not-urgent), #A78BFA);
            color: white;
        }
      
        .sound-controls {
            margin: 25px 0;
            background: var(--glass);
            padding: 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            text-align: center;
        }
      
        .sound-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
      
        .sound-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }
      
        .sound-btn {
            padding: 14px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: rgba(15, 23, 42, 0.5);
            color: var(--text);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 80px;
            transition: all 0.3s ease;
            width: 100%;
        }
      
        .sound-btn[data-sound="none"] {
            grid-column: span 3;
        }
      
        .sound-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }
      
        .sound-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
      
        .sound-btn i {
            font-size: 20px;
            margin-bottom: 8px;
        }
      
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 25px 0;
            padding: 20px;
            background: var(--glass);
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            justify-items: center;
        }
      
        .stat-item {
            text-align: center;
        }
      
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }
      
        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
      
        .settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
      
        .settings-modal.active {
            opacity: 1;
            visibility: visible;
        }
      
        .settings-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
      
        .settings-modal.active .settings-content {
            transform: translateY(0);
        }
      
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
      
        .settings-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }
      
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--card-border);
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
      
        .close-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
      
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
            justify-items: center;
        }
      
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            width: 100%;
        }
      
        .setting-item.full-width {
            grid-column: span 2;
        }
      
        .setting-label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
            text-align: center;
        }
      
        .setting-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: var(--glass);
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }
      
        .setting-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
      
        .settings-save {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
      
        .settings-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
      
        .local-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            z-index: 9999;
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 20px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            border: 1px solid var(--card-border);
            border-left: 4px solid var(--primary);
            backdrop-filter: blur(20px);
        }
      
        .local-notification.show {
            transform: translateX(0);
        }
      
        .notification-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-light);
            text-align: center;
        }
      
        .notification-message {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 15px;
            line-height: 1.5;
            text-align: center;
        }
      
        .notification-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
      
        .notification-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
      
        .notification-btn.start {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
      
        .notification-btn.start:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
      
        .notification-btn.later {
            background: transparent;
            color: var(--text-light);
            border: 2px solid var(--card-border);
        }
      
        .notification-btn.later:hover {
            border-color: var(--text-light);
            color: var(--text);
        }
      
        .comment-input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 13px;
            resize: vertical;
            min-height: 40px;
            max-height: 100px;
            display: none;
        }
      
        .comment-input.show {
            display: block;
        }
      
        .comment-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
            display: none;
        }
      
        .comment-actions.show {
            display: flex;
        }
      
        .comment-btn-small {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
      
        .comment-btn-small.save {
            background: var(--secondary);
            color: white;
        }
      
        .comment-btn-small.cancel {
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--card-border);
        }
      
        .comment-btn-small:hover {
            transform: translateY(-1px);
        }
      
        @media (max-width: 540px) {
            body {
                padding: 15px;
                align-items: flex-start;
                padding-top: 30px;
            }
          
            .container {
                padding: 25px 20px;
            }
          
            .timer-display {
                font-size: 60px;
            }
          
            .progress-ring {
                width: 200px;
                height: 200px;
            }
          
            .mode-selector {
                flex-direction: column;
            }
          
            .mode-btn {
                max-width: 100%;
            }
          
            .controls {
                grid-template-columns: 1fr;
            }
          
            .task-input-container {
                flex-direction: column;
                align-items: stretch;
            }
          
            .intervals-container {
                width: 100%;
            }
          
            .sound-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
          
            .sound-btn[data-sound="none"] {
                grid-column: span 2;
            }
          
            .settings-grid {
                grid-template-columns: 1fr;
            }
          
            .setting-item.full-width {
                grid-column: span 1;
            }
          
            .stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
      
        @media (max-width: 380px) {
            .timer-display {
                font-size: 52px;
            }
          
            .progress-ring {
                width: 180px;
                height: 180px;
            }
          
            .sound-buttons {
                grid-template-columns: 1fr;
            }
          
            .sound-btn[data-sound="none"] {
                grid-column: span 1;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Pomodoro Flow</h1>
        <p>–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤–∞–∂–Ω–æ–º —Å –ø–æ–º–æ—â—å—é —Ç–µ—Ö–Ω–∏–∫–∏ –ø–æ–º–∏–¥–æ—Ä–æ</p>
        <button class="settings-btn" id="settingsBtn"><i class="fas fa-sliders-h"></i></button>
    </div>
    <div class="timer-section">
        <div class="progress-ring">
            <svg width="220" height="220" viewBox="0 0 220 220">
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#8B5CF6" />
                        <stop offset="100%" stop-color="#10B981" />
                    </linearGradient>
                </defs>
                <circle class="progress-ring-circle progress-ring-bg" cx="110" cy="110" r="100"></circle>
                <circle class="progress-ring-circle progress-ring-fill" cx="110" cy="110" r="100" stroke-dasharray="628" stroke-dashoffset="0"></circle>
            </svg>
        </div>
        <div class="timer-display" id="display">25:00</div>
        <div class="mode-indicator work" id="modeIndicator">–†–∞–±–æ—Ç–∞</div>
        <div class="mode-selector">
            <button class="mode-btn active" id="workModeBtn"><i class="fas fa-briefcase"></i> –†–∞–±–æ—Ç–∞</button>
            <button class="mode-btn break" id="breakModeBtn"><i class="fas fa-coffee"></i> –ü–µ—Ä–µ—Ä—ã–≤</button>
        </div>
    </div>
    <div class="current-task-section">
        <div class="current-task empty" id="currentTaskDisplay">–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
    </div>
    <div class="controls">
        <button class="control-btn start" id="startBtn"><i class="fas fa-play"></i> –°—Ç–∞—Ä—Ç</button>
        <button class="control-btn pause" id="pauseBtn"><i class="fas fa-pause"></i> –ü–∞—É–∑–∞</button>
        <button class="control-btn reset" id="resetBtn"><i class="fas fa-redo"></i> –°–±—Ä–æ—Å</button>
    </div>
    <div class="tasks-section">
        <div class="section-title"><i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏</div>
        <div class="task-input-container">
            <input type="text" class="task-input" id="taskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞...">
            <div class="intervals-container">
                <input type="number" class="intervals-input" id="taskIntervals" value="1" min="1" max="10">
                <div class="intervals-label" id="intervalsLabel">1 –ø–æ–º–∏–¥–æ—Ä–∫–∞</div>
            </div>
            <button class="add-btn" id="addTaskBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ -->
        <div class="tag-selector" id="tagSelector">
            <button class="tag-selector-btn important-urgent active" data-tag="important-urgent">
                <i class="fas fa-exclamation-circle"></i> –í–∞–∂–Ω–æ & –°—Ä–æ—á–Ω–æ
            </button>
            <button class="tag-selector-btn important-not-urgent" data-tag="important-not-urgent">
                <i class="fas fa-calendar-check"></i> –í–∞–∂–Ω–æ & –ù–µ—Å—Ä–æ—á–Ω–æ
            </button>
            <button class="tag-selector-btn not-important-urgent" data-tag="not-important-urgent">
                <i class="fas fa-clock"></i> –ù–µ–≤–∞–∂–Ω–æ & –°—Ä–æ—á–Ω–æ
            </button>
            <button class="tag-selector-btn not-important-not-urgent" data-tag="not-important-not-urgent">
                <i class="fas fa-trash-alt"></i> –ù–µ–≤–∞–∂–Ω–æ & –ù–µ—Å—Ä–æ—á–Ω–æ
            </button>
        </div>
        <div class="task-progress" id="taskProgress" style="display:none;">
            <div class="task-progress-text">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:</div>
            <div class="task-progress-count" id="completedIntervalsDisplay">0/1</div>
        </div>
        <div class="task-list" id="taskList"></div>
    </div>
    <div class="sound-controls">
        <div class="sound-title"><i class="fas fa-music"></i> –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</div>
        <div class="sound-buttons" id="soundButtons">
            <button class="sound-btn" data-sound="fire"><i class="fas fa-fire"></i> –ö–æ—Å—Ç–µ—Ä</button>
            <button class="sound-btn" data-sound="rain"><i class="fas fa-cloud-rain"></i> –î–æ–∂–¥—å</button>
            <button class="sound-btn" data-sound="forest"><i class="fas fa-tree"></i> –õ–µ—Å</button>
            <button class="sound-btn active" data-sound="none"><i class="fas fa-volume-mute"></i> –ë–µ–∑ –∑–≤—É–∫–∞</button>
        </div>
    </div>
    <div class="stats">
        <div class="stat-item"><div class="stat-value" id="completedSessions">0</div><div class="stat-label">–°–µ—Å—Å–∏–π</div></div>
        <div class="stat-item"><div class="stat-value" id="totalTime">0</div><div class="stat-label">–ú–∏–Ω—É—Ç</div></div>
        <div class="stat-item"><div class="stat-value" id="tasksCompleted">0</div><div class="stat-label">–ó–∞–¥–∞—á</div></div>
    </div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div class="settings-modal" id="settingsModal">
    <div class="settings-content">
        <div class="settings-header">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="close-btn" id="closeSettings"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-grid">
            <div class="setting-item">
                <label class="setting-label">–†–∞–±–æ—Ç–∞ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="workDuration" value="25" min="1" max="60">
            </div>
            <div class="setting-item">
                <label class="setting-label">–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="shortBreakDuration" value="5" min="1" max="30">
            </div>
            <div class="setting-item">
                <label class="setting-label">–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                <input type="number" class="setting-input" id="longBreakDuration" value="15" min="1" max="60">
            </div>
            <div class="setting-item">
                <label class="setting-label">–°–µ—Å—Å–∏–π –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ</label>
                <input type="number" class="setting-input" id="sessionsUntilLongBreak" value="4" min="1" max="10">
            </div>
            <div class="setting-item full-width">
                <label class="setting-label">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="currentProgressDisplay">0/4</span></label>
                <div class="progress-container" style="height:6px;margin:8px 0; background: rgba(255,255,255,0.1); border-radius:3px;">
                    <div class="progress-bar" id="longBreakProgressBar" style="height:100%; background:linear-gradient(90deg,#8B5CF6,#10B981); border-radius:3px; width:0%; transition:width .5s ease;"></div>
                </div>
            </div>
        </div>
        <button class="settings-save" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
</div>
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div class="local-notification" id="localNotification">
    <div class="notification-title" id="notificationTitle">–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</div>
    <div class="notification-message" id="notificationMessage"></div>
    <div class="notification-buttons">
        <button class="notification-btn start" id="notificationStartBtn">–ù–∞—á–∞—Ç—å</button>
        <button class="notification-btn later" id="notificationLaterBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>
<!-- –ó–≤—É–∫–∏ -->
<audio id="work-end-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
</audio>
<audio id="break-end-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-alarm-995.mp3" type="audio/mpeg">
</audio>
<audio id="fire-track" loop preload="none">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/22/audio_aa2f4e87d7.mp3" type="audio/mpeg">
</audio>
<audio id="rain-track" loop preload="none">
    <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_9e0e3e8d3d.mp3" type="audio/mpeg">
</audio>
<audio id="forest-track" loop preload="none">
    <source src="https://cdn.pixabay.com/audio/2022/05/25/audio_f3b2c1e8d3.mp3" type="audio/mpeg">
</audio>
<script>
// =============================================================================
// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
// =============================================================================
const WORK_MODE = 'work';
const BREAK_SHORT_MODE = 'shortBreak';
const BREAK_LONG_MODE = 'longBreak';
let mode = WORK_MODE;
let isRunning = false;
let timerId = null;
let endTime = null;
let sessionsCompleted = 0;
let tasksCompleted = 0;
let totalTimeWorked = 0;
let tasks = [];
let currentTaskIndex = -1;
let sessionsUntilLongBreak = 4;
let currentTaskIntervalsCompleted = 0;
let currentTaskTotalIntervals = 1;
let currentSoundCategory = 'none';
let isSoundPlaying = false;
let notificationPermission = false;
// –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –ø–∞—É–∑–µ
let remainingSeconds = 0;
// –¢–µ–≥–∏ –¥–ª—è –∑–∞–¥–∞—á
let availableTags = [
    { id: 'important-urgent', name: '–í–∞–∂–Ω–æ & –°—Ä–æ—á–Ω–æ', color: 'important-urgent' },
    { id: 'important-not-urgent', name: '–í–∞–∂–Ω–æ & –ù–µ—Å—Ä–æ—á–Ω–æ', color: 'important-not-urgent' },
    { id: 'not-important-urgent', name: '–ù–µ–≤–∞–∂–Ω–æ & –°—Ä–æ—á–Ω–æ', color: 'not-important-urgent' },
    { id: 'not-important-not-urgent', name: '–ù–µ–≤–∞–∂–Ω–æ & –ù–µ—Å—Ä–æ—á–Ω–æ', color: 'not-important-not-urgent' }
];
let currentTagForNewTask = 'important-urgent'; // –¢–µ–∫—É—â–∏–π —Ç–µ–≥ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
let selectedTagFilter = null; // –§–∏–ª—å—Ç—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è drag and drop
let draggedTask = null;
let draggedTaskIndex = -1;
// =============================================================================
// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
// =============================================================================
const display = document.getElementById('display');
const progressRing = document.querySelector('.progress-ring-fill');
const modeIndicator = document.getElementById('modeIndicator');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const workModeBtn = document.getElementById('workModeBtn');
const breakModeBtn = document.getElementById('breakModeBtn');
const workDurationInput = document.getElementById('workDuration');
const shortBreakInput = document.getElementById('shortBreakDuration');
const longBreakInput = document.getElementById('longBreakDuration');
const sessionsUntilLongBreakInput = document.getElementById('sessionsUntilLongBreak');
const currentProgressDisplay = document.getElementById('currentProgressDisplay');
const longBreakProgressBar = document.getElementById('longBreakProgressBar');
const taskInput = document.getElementById('taskInput');
const taskIntervalsInput = document.getElementById('taskIntervals');
const intervalsLabel = document.getElementById('intervalsLabel');
const addTaskBtn = document.getElementById('addTaskBtn');
const taskListEl = document.getElementById('taskList');
const currentTaskDisplay = document.getElementById('currentTaskDisplay');
const completedSessionsEl = document.getElementById('completedSessions');
const totalTimeEl = document.getElementById('totalTime');
const tasksCompletedEl = document.getElementById('tasksCompleted');
const taskProgressEl = document.getElementById('taskProgress');
const completedIntervalsDisplay = document.getElementById('completedIntervalsDisplay');
const tagSelector = document.getElementById('tagSelector');
// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
const localNotification = document.getElementById('localNotification');
const notificationTitle = document.getElementById('notificationTitle');
const notificationMessage = document.getElementById('notificationMessage');
const notificationStartBtn = document.getElementById('notificationStartBtn');
const notificationLaterBtn = document.getElementById('notificationLaterBtn');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const saveSettingsBtn = document.getElementById('saveSettings');
// =============================================================================
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// =============================================================================
resetTimer();
checkNotificationPermission();
updateModeButtons();
updateLongBreakProgress();
updateIntervalsLabel();
initTagSelector();
// =============================================================================
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
// =============================================================================
startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);
workModeBtn.addEventListener('click', () => setMode(WORK_MODE));
breakModeBtn.addEventListener('click', () => setMode(BREAK_SHORT_MODE));
addTaskBtn.addEventListener('click', addTask);
taskInput.addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });
notificationStartBtn.addEventListener('click', startFromNotification);
notificationLaterBtn.addEventListener('click', hideLocalNotification);
settingsBtn.addEventListener('click', () => {
    updateLongBreakProgress();
    settingsModal.classList.add('active');
});
closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
saveSettingsBtn.addEventListener('click', saveSettingsHandler);
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–¥–ø–∏—Å–∏ "–ø–æ–º–∏–¥–æ—Ä–æ–∫" –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è
taskIntervalsInput.addEventListener('input', updateIntervalsLabel);
// –ó–≤—É–∫–∏
document.querySelectorAll('.sound-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        setSoundCategory(btn.dataset.sound);
        document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});
workDurationInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
shortBreakInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
longBreakInput.addEventListener('input', () => { if (!isRunning) resetTimer(); });
sessionsUntilLongBreakInput.addEventListener('input', updateLongBreakSettings);
// =============================================================================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
// =============================================================================
function initTagSelector() {
    const tagButtons = tagSelector.querySelectorAll('.tag-selector-btn');
    tagButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const tag = btn.dataset.tag;
            selectTagForNewTask(tag);
        });
    });
}
function selectTagForNewTask(tag) {
    currentTagForNewTask = tag;
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤
    updateTagSelectorButtons();
}
function updateTagSelectorButtons() {
    const tagButtons = tagSelector.querySelectorAll('.tag-selector-btn');
    tagButtons.forEach(btn => {
        if (btn.dataset.tag === currentTagForNewTask) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}
function updateIntervalsLabel() {
    const intervals = parseInt(taskIntervalsInput.value) || 1;
    let label;
  
    if (intervals === 1) {
        label = '1 –ø–æ–º–∏–¥–æ—Ä–∫–∞';
    } else if (intervals >= 2 && intervals <= 4) {
        label = `${intervals} –ø–æ–º–∏–¥–æ—Ä–∫–∏`;
    } else {
        label = `${intervals} –ø–æ–º–∏–¥–æ—Ä–æ–∫`;
    }
  
    intervalsLabel.textContent = label;
}
function showQuickNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--card-bg);
        color: var(--text);
        padding: 12px 20px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease;
        backdrop-filter: blur(20px);
    `;
  
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
            <i class="fas fa-tag" style="color: ${getTagColor(currentTagForNewTask)}"></i>
            <div>${message}</div>
        </div>
    `;
  
    document.body.appendChild(notification);
  
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}
function getTagColor(tagId) {
    switch(tagId) {
        case 'important-urgent': return '#FCA5A5';
        case 'important-not-urgent': return '#A7F3D0';
        case 'not-important-urgent': return '#FDE68A';
        case 'not-important-not-urgent': return '#C4B5FD';
        default: return 'var(--text-light)';
    }
}
// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
  
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
// =============================================================================
// –¢–∞–π–º–µ—Ä
// =============================================================================
function getDuration() {
    if (mode === WORK_MODE) return Number(workDurationInput.value) * 60 || 1500;
    if (mode === BREAK_SHORT_MODE) return Number(shortBreakInput.value) * 60 || 300;
    if (mode === BREAK_LONG_MODE) return Number(longBreakInput.value) * 60 || 900;
    return 1500;
}
function setMode(newMode) {
    if (isRunning) pauseTimer();
    mode = (newMode === BREAK_LONG_MODE || newMode === BREAK_SHORT_MODE) ? newMode : WORK_MODE;
  
    // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    remainingSeconds = 0;
    endTime = Date.now() + getDuration() * 1000;
    updateDisplay(getDuration());
    updateProgressRing(0);
  
    updateModeIndicator();
    updateModeButtons();
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
}
function startTimer() {
    if (isRunning) return;
    isRunning = true;
  
    // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –±—ã–ª –Ω–∞ –ø–∞—É–∑–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    // –ò–Ω–∞—á–µ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–ª–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (remainingSeconds > 0) {
        endTime = Date.now() + remainingSeconds * 1000;
    } else {
        endTime = Date.now() + getDuration() * 1000;
        remainingSeconds = getDuration();
    }
    startBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${mode === WORK_MODE ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' : '–û—Ç–¥—ã—Ö'}`;
    startBtn.disabled = true;
    if (currentSoundCategory !== 'none' && !isSoundPlaying) playBackgroundSound();
    tick();
    timerId = setInterval(tick, 980);
}
function tick() {
    if (!isRunning) return;
    const remainingMs = Math.max(0, endTime - Date.now());
    remainingSeconds = Math.round(remainingMs / 1000);
    updateDisplay(remainingSeconds);
    updateProgressRing((getDuration() - remainingSeconds) / getDuration());
    if (mode === WORK_MODE) {
        const minWorked = Math.floor((getDuration() - remainingSeconds) / 60);
        if (minWorked > totalTimeWorked) {
            totalTimeWorked = minWorked;
            updateStats();
        }
    }
    if (remainingMs <= 0) handleSessionEnd();
}
function pauseTimer() {
    if (!isRunning) return;
    isRunning = false;
    clearInterval(timerId);
    timerId = null;
  
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const remainingMs = Math.max(0, endTime - Date.now());
    remainingSeconds = Math.round(remainingMs / 1000);
  
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–¥—ã—Ö'}`;
    startBtn.disabled = false;
}
function resetTimer() {
    pauseTimer();
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
    remainingSeconds = 0;
    endTime = Date.now() + getDuration() * 1000;
    updateDisplay(getDuration());
    updateProgressRing(0);
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
    startBtn.disabled = false;
}
function handleSessionEnd() {
    clearInterval(timerId);
    timerId = null;
    isRunning = false;
    remainingSeconds = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
    if (mode === WORK_MODE) {
        playAlertSound('work-end-sound');
        sessionsCompleted++;
        currentTaskIntervalsCompleted++;
        updateTaskProgress();
        updateLongBreakProgress();
        if (isSoundPlaying) pauseBackgroundSound();
        const needed = Number(sessionsUntilLongBreakInput.value) || 4;
        const isLong = sessionsCompleted % needed === 0;
        showNotification(
            isLong ? '–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤!' : '–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤',
            isLong
                ? `–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ ${longBreakInput.value} –º–∏–Ω—É—Ç. –û—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏!`
                : `–ü–µ—Ä–µ—Ä—ã–≤. –î–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å ${needed - (sessionsCompleted % needed)} —Å–µ—Å—Å–∏–π.`,
            'break'
        );
        setTimeout(() => setMode(isLong ? BREAK_LONG_MODE : BREAK_SHORT_MODE), 800);
    } else {
        playAlertSound('break-end-sound');
        showNotification(
            '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å!',
            '–ü–µ—Ä–µ—Ä—ã–≤ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∑–∞–¥–∞—á–µ.',
            'work'
        );
        setTimeout(() => setMode(WORK_MODE), 800);
    }
    startBtn.disabled = false;
    startBtn.innerHTML = `<i class="fas fa-play"></i> ${mode === WORK_MODE ? '–°—Ç–∞—Ä—Ç' : '–ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö'}`;
}
// =============================================================================
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
// =============================================================================
function showNotification(title, msg, type = 'info') {
    notificationTitle.textContent = title;
    notificationMessage.textContent = msg;
    localNotification.classList.add('show');
    if (type === 'break') {
        modeIndicator.classList.remove('work');
        modeIndicator.classList.add('break');
    } else {
        modeIndicator.classList.remove('break');
        modeIndicator.classList.add('work');
    }
    setTimeout(() => localNotification.classList.remove('show'), 10000);
    if (notificationPermission) {
        new Notification(title, { body: msg });
    }
}
function hideLocalNotification() {
    localNotification.classList.remove('show');
}
function startFromNotification() {
    hideLocalNotification();
    startTimer();
}
// =============================================================================
// –ó–≤—É–∫–∏
// =============================================================================
function playAlertSound(id) {
    const snd = document.getElementById(id);
    snd.currentTime = 0;
    snd.volume = 0.7;
    snd.play().catch(e => console.log("–ó–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω", e));
}
function playBackgroundSound() {
    stopAllBackgroundSounds();
    const audio = document.getElementById(currentSoundCategory + '-track');
    if (audio) {
        audio.volume = 0.3;
        audio.play().catch(() => {});
        isSoundPlaying = true;
    }
}
function pauseBackgroundSound() {
    const audio = document.getElementById(currentSoundCategory + '-track');
    if (audio) {
        audio.pause();
        isSoundPlaying = false;
    }
}
function stopAllBackgroundSounds() {
    ['fire','rain','forest'].forEach(s => {
        const a = document.getElementById(s + '-track');
        if (a) { a.pause(); a.currentTime = 0; }
    });
    isSoundPlaying = false;
}
function setSoundCategory(cat) {
    pauseBackgroundSound();
    currentSoundCategory = cat;
    if (isRunning && cat !== 'none') playBackgroundSound();
}
// =============================================================================
// –ó–∞–¥–∞—á–∏ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
// =============================================================================
function addTask() {
    const text = taskInput.value.trim();
    const intervals = Number(taskIntervalsInput.value) || 1;
    if (!text) return;
    const task = {
        id: Date.now(),
        text: text,
        intervals,
        tags: [currentTagForNewTask], // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–≥
        completedIntervals: 0,
        completed: false,
        comment: '' // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    };
    tasks.push(task);
    renderTaskList();
    taskInput.value = '';
    taskInput.focus();
    if (currentTaskIndex === -1) selectTask(tasks.length - 1);
  
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const tagName = availableTags.find(t => t.id === currentTagForNewTask)?.name || currentTagForNewTask;
    showQuickNotification(`–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å —Ç–µ–≥–æ–º: ${tagName}`);
}
function renderTaskList() {
    taskListEl.innerHTML = '';
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É
    let filteredTasks = tasks;
    if (selectedTagFilter) {
        filteredTasks = tasks.filter(task =>
            task.tags && task.tags.includes(selectedTagFilter)
        );
    }
    if (filteredTasks.length === 0) {
        taskListEl.innerHTML = `
            <div style="padding:20px; text-align:center; color:var(--text-light);">
                <i class="fas fa-tasks" style="font-size:20px; margin-bottom:10px; display:block;"></i>
                ${selectedTagFilter ? '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' : '–ù–µ—Ç –∑–∞–¥–∞—á'}<br>
                <small style="font-size:11px;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å</small>
            </div>
        `;
        return;
    }
    filteredTasks.forEach((task, i) => {
        // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∑–∞–¥–∞—á–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
        const originalIndex = tasks.findIndex(t => t.id === task.id);
        const isActive = originalIndex === currentTaskIndex;
      
        const item = document.createElement('div');
        item.className = `task-item ${isActive ? 'active' : ''}`;
        item.dataset.id = task.id;
        item.dataset.index = originalIndex;
        item.draggable = true;
        const tagInfo = availableTags.find(t => t.id === task.tags[0]) || availableTags[0];
        item.innerHTML = `
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTaskCompletion(${task.id})"></div>
            <div class="task-content">
                <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                ${task.comment ? `<div class="task-comment show">${task.comment}</div>` : ''}
                <textarea class="comment-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="display:none;">${task.comment || ''}</textarea>
                <div class="comment-actions" style="display:none;">
                    <button class="comment-btn-small save" onclick="saveComment(${task.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="comment-btn-small cancel" onclick="cancelComment(${task.id})">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div class="task-meta">
                    <div class="task-intervals-badge">${task.completedIntervals}/${task.intervals}</div>
                    <div class="task-tags">
                        <span class="task-tag ${tagInfo.color} ${currentTagForNewTask === task.tags[0] ? 'active' : ''}"
                              onclick="event.stopPropagation(); changeTaskTag(${task.id})">${tagInfo.name}</span>
                    </div>
                </div>
            </div>
            <div class="task-actions">
                <button class="task-btn comment-btn" onclick="toggleCommentInput(${task.id})">
                    <i class="fas fa-comment${task.comment ? '-dots' : ''}"></i>
                </button>
                <button class="task-btn delete" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;
        // –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á–∏
        item.addEventListener('click', e => {
            if (!e.target.closest('.task-checkbox') &&
                !e.target.closest('.task-btn') &&
                !e.target.closest('.task-tag') &&
                !e.target.closest('.drag-handle') &&
                !e.target.closest('.comment-input') &&
                !e.target.closest('.comment-actions')) {
                selectTask(originalIndex);
            }
        });
        // Drag and drop —Å–æ–±—ã—Ç–∏—è
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
        taskListEl.appendChild(item);
    });
}
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
window.toggleCommentInput = function(taskId) {
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
  
    const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
    if (!taskItem) return;
  
    const commentInput = taskItem.querySelector('.comment-input');
    const commentActions = taskItem.querySelector('.comment-actions');
    const commentDisplay = taskItem.querySelector('.task-comment');
  
    if (commentInput.style.display === 'block') {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        commentInput.style.display = 'none';
        commentActions.style.display = 'none';
        if (tasks[taskIndex].comment && commentDisplay) {
            commentDisplay.style.display = 'block';
        }
    } else {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        commentInput.value = tasks[taskIndex].comment || '';
        commentInput.style.display = 'block';
        commentActions.style.display = 'flex';
        if (commentDisplay) {
            commentDisplay.style.display = 'none';
        }
        commentInput.focus();
    }
};
window.saveComment = function(taskId) {
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
  
    const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
    if (!taskItem) return;
  
    const commentInput = taskItem.querySelector('.comment-input');
    tasks[taskIndex].comment = commentInput.value.trim();
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderTaskList();
  
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (tasks[taskIndex].comment) {
        showQuickNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    }
};
window.cancelComment = function(taskId) {
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
  
    const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
    if (!taskItem) return;
  
    const commentInput = taskItem.querySelector('.comment-input');
    commentInput.value = tasks[taskIndex].comment || '';
  
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
    commentInput.style.display = 'none';
    taskItem.querySelector('.comment-actions').style.display = 'none';
  
    if (tasks[taskIndex].comment) {
        const commentDisplay = taskItem.querySelector('.task-comment');
        if (commentDisplay) {
            commentDisplay.style.display = 'block';
        }
    }
};
// –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–≥–∞ –∑–∞–¥–∞—á–∏
window.changeTaskTag = function(taskId) {
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
  
    // –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–≥ –∏–∑ —Å–ø–∏—Å–∫–∞
    const currentTag = tasks[taskIndex].tags[0];
    const currentTagIndex = availableTags.findIndex(t => t.id === currentTag);
    const nextTagIndex = (currentTagIndex + 1) % availableTags.length;
    const nextTag = availableTags[nextTagIndex];
  
    tasks[taskIndex].tags = [nextTag.id];
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderTaskList();
  
    // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (taskIndex === currentTaskIndex) {
        selectTask(taskIndex);
    }
  
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showQuickNotification(`–¢–µ–≥ –∑–∞–¥–∞—á–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${nextTag.name}`);
};
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è drag and drop
function handleDragStart(e) {
    draggedTask = this;
    draggedTaskIndex = parseInt(this.dataset.index);
    this.classList.add('dragging');
  
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞
    e.dataTransfer.setData('text/plain', this.dataset.id);
    e.dataTransfer.effectAllowed = 'move';
}
function handleDragOver(e) {
    e.preventDefault();
    this.classList.add('drag-over');
    e.dataTransfer.dropEffect = 'move';
}
function handleDragLeave() {
    this.classList.remove('drag-over');
}
function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
  
    const draggedId = e.dataTransfer.getData('text/plain');
    const targetId = this.dataset.id;
  
    if (draggedId === targetId) return;
  
    const draggedIndex = tasks.findIndex(t => t.id === parseInt(draggedId));
    const targetIndex = tasks.findIndex(t => t.id === parseInt(targetId));
  
    if (draggedIndex === -1 || targetIndex === -1) return;
  
    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∑–∞–¥–∞—á—É –≤ –º–∞—Å—Å–∏–≤–µ
    const [draggedItem] = tasks.splice(draggedIndex, 1);
    tasks.splice(targetIndex, 0, draggedItem);
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
    if (currentTaskIndex === draggedIndex) {
        currentTaskIndex = targetIndex;
    } else if (currentTaskIndex === targetIndex) {
        currentTaskIndex = draggedIndex;
    }
  
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    renderTaskList();
  
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showQuickNotification('–ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞');
}
function handleDragEnd() {
    this.classList.remove('dragging');
    document.querySelectorAll('.task-item').forEach(item => {
        item.classList.remove('drag-over');
    });
    draggedTask = null;
    draggedTaskIndex = -1;
}
// –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á –ø–æ —Ç–µ–≥—É
window.filterTasksByTag = function(tag) {
    if (selectedTagFilter === tag) {
        // –ï—Å–ª–∏ —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —ç—Ç–æ–º—É —Ç–µ–≥—É, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        selectedTagFilter = null;
    } else {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        selectedTagFilter = tag;
    }
  
    renderTaskList();
  
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    if (selectedTagFilter) {
        const tagName = availableTags.find(t => t.id === tag)?.name || tag;
        showQuickNotification(`–ü–æ–∫–∞–∑–∞–Ω—ã –∑–∞–¥–∞—á–∏ —Å —Ç–µ–≥–æ–º: ${tagName}`);
    } else {
        showQuickNotification('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –∑–∞–¥–∞—á–∏');
    }
};
window.toggleTaskCompletion = function(id) {
    const idx = tasks.findIndex(t => t.id === id);
    if (idx === -1) return;
    tasks[idx].completed = !tasks[idx].completed;
    if (tasks[idx].completed) tasksCompleted++;
    else tasksCompleted--;
    updateStats();
    renderTaskList();
    if (idx === currentTaskIndex && tasks[idx].completed) {
        const next = findNextIncompleteTask();
        if (next !== -1) selectTask(next);
    }
};
window.deleteTask = function(id) {
    const idx = tasks.findIndex(t => t.id === id);
    if (idx === -1) return;
    if (tasks[idx].completed) tasksCompleted--;
    if (idx === currentTaskIndex) {
        const next = findNextIncompleteTask(idx);
        tasks.splice(idx, 1);
        if (next !== -1) selectTask(next < tasks.length ? next : tasks.length - 1);
        else currentTaskIndex = -1;
    } else {
        tasks.splice(idx, 1);
        if (currentTaskIndex > idx) currentTaskIndex--;
    }
    renderTaskList();
    updateStats();
    if (currentTaskIndex === -1) {
        currentTaskDisplay.classList.add('empty');
        currentTaskDisplay.textContent = '–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        taskProgressEl.style.display = 'none';
    }
};
function selectTask(index) {
    if (index < 0 || index >= tasks.length) return;
    currentTaskIndex = index;
    const t = tasks[index];
    const tagInfo = availableTags.find(tag => tag.id === t.tags[0]) || availableTags[0];
    currentTaskDisplay.innerHTML = `
        ${t.text}
        <span class="task-intervals" style="color: var(--primary-light); font-weight: 600; background: rgba(139,92,246,0.1); padding: 2px 8px; border-radius: 10px;">
            ${t.completedIntervals}/${t.intervals}
        </span>
        <span class="task-tag ${tagInfo.color}" style="font-size: 10px; margin-left: 5px;">
            ${tagInfo.name}
        </span>
        ${t.comment ? `<div style="font-size:12px; color:var(--text-light); margin-top:5px;"><i class="fas fa-comment"></i> ${t.comment}</div>` : ''}
    `;
    currentTaskDisplay.classList.remove('empty');
    currentTaskIntervalsCompleted = t.completedIntervals;
    currentTaskTotalIntervals = t.intervals;
    updateTaskProgress();
    taskProgressEl.style.display = 'flex';
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Å–ø–∏—Å–∫–µ
    document.querySelectorAll('.task-item').forEach((el,i) => {
        const taskId = el.dataset.id;
        if (taskId) {
            const taskIndex = tasks.findIndex(t => t.id === parseInt(taskId));
            el.classList.toggle('active', taskIndex === index);
        }
    });
}
function updateTaskProgress() {
    completedIntervalsDisplay.textContent = `${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}`;
    if (currentTaskIndex === -1) return;
    tasks[currentTaskIndex].completedIntervals = currentTaskIntervalsCompleted;
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –≤ —Å–ø–∏—Å–∫–µ
    const items = taskListEl.querySelectorAll('.task-item');
    items.forEach(item => {
        const taskId = item.dataset.id;
        if (taskId && parseInt(taskId) === tasks[currentTaskIndex].id) {
            const badge = item.querySelector('.task-intervals-badge');
            if (badge) badge.textContent = `${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}`;
        }
    });
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É —Å–≤–µ—Ä—Ö—É
    if (!currentTaskDisplay.classList.contains('empty')) {
        const t = tasks[currentTaskIndex];
        const tagInfo = availableTags.find(tag => tag.id === t.tags[0]) || availableTags[0];
      
        currentTaskDisplay.innerHTML = `
            ${t.text}
            <span class="task-intervals" style="color: var(--primary-light); font-weight: 600; background: rgba(139,92,246,0.1); padding: 2px 8px; border-radius: 10px;">
                ${currentTaskIntervalsCompleted}/${currentTaskTotalIntervals}
            </span>
            <span class="task-tag ${tagInfo.color}" style="font-size: 10px; margin-left: 5px;">
                ${tagInfo.name}
            </span>
            ${t.comment ? `<div style="font-size:12px; color:var(--text-light); margin-top:5px;"><i class="fas fa-comment"></i> ${t.comment}</div>` : ''}
        `;
    }
    if (currentTaskIntervalsCompleted >= currentTaskTotalIntervals) {
        tasks[currentTaskIndex].completed = true;
        tasksCompleted++;
        updateStats();
        renderTaskList();
        const next = findNextIncompleteTask();
        if (next !== -1) selectTask(next);
        else {
            currentTaskIndex = -1;
            currentTaskDisplay.classList.add('empty');
            currentTaskDisplay.textContent = '–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            taskProgressEl.style.display = 'none';
        }
    }
}
function findNextIncompleteTask(start = 0) {
    for (let i = start; i < tasks.length; i++) {
        if (!tasks[i].completed) return i;
    }
    for (let i = 0; i < start; i++) {
        if (!tasks[i].completed) return i;
    }
    return -1;
}
// =============================================================================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// =============================================================================
function updateDisplay(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    display.textContent = `${m}:${s}`;
}
function updateProgressRing(progress) {
    const circumference = 2 * Math.PI * 100;
    const offset = circumference - (progress * circumference);
    progressRing.style.strokeDashoffset = offset;
}
function updateModeIndicator() {
    modeIndicator.textContent = mode === WORK_MODE ? '–†–∞–±–æ—Ç–∞' : '–ü–µ—Ä–µ—Ä—ã–≤';
    if (mode === WORK_MODE) {
        modeIndicator.classList.remove('break');
        modeIndicator.classList.add('work');
    } else {
        modeIndicator.classList.remove('work');
        modeIndicator.classList.add('break');
    }
}
function updateModeButtons() {
    workModeBtn.classList.toggle('active', mode === WORK_MODE);
    breakModeBtn.classList.toggle('active', mode !== WORK_MODE);
}
function updateStats() {
    completedSessionsEl.textContent = sessionsCompleted;
    totalTimeEl.textContent = totalTimeWorked;
    tasksCompletedEl.textContent = tasksCompleted;
}
function checkNotificationPermission() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
        notificationPermission = true;
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(perm => {
            notificationPermission = perm === "granted";
        });
    }
}
function updateLongBreakProgress() {
    const needed = Number(sessionsUntilLongBreakInput.value) || 4;
    const progress = sessionsCompleted % needed;
    currentProgressDisplay.textContent = `${progress}/${needed}`;
    longBreakProgressBar.style.width = `${(progress / needed) * 100}%`;
}
function updateLongBreakSettings() {
    sessionsUntilLongBreak = Number(sessionsUntilLongBreakInput.value) || 4;
    updateLongBreakProgress();
}
function saveSettingsHandler() {
    updateLongBreakSettings();
    settingsModal.classList.remove('active');
    if (!isRunning) resetTimer();
}
// =============================================================================
// –°—Ç–∞—Ä—Ç
// =============================================================================
renderTaskList();
</script>
</body>
</html>
