<script>
let activeQuadrant = null, editingNote = null, draggedNote = null;
let timerInterval = null, mode = 'work', endTime = 0;
const beep = new Audio("https://www.soundjay.com/button/beep-07.wav");

document.querySelectorAll('.quadrant').forEach(q=>{
  q.onclick = e => { 
    if(e.target.closest('.note')) return;
    activeQuadrant = q;
    openModal(null);
  };
  q.ondragover = e => { e.preventDefault(); q.classList.add('drag-over'); };
  q.ondragleave = () => q.classList.remove('drag-over');
  q.ondrop = () => {
    q.classList.remove('drag-over');
    if(draggedNote){ 
      q.appendChild(draggedNote);
      updateNoteColor(draggedNote,q);
    }
  };
});

function updateNoteColor(note,q){
  note.style.backgroundColor=`color-mix(in srgb, ${getComputedStyle(q).getPropertyValue('--q')} 25%, rgba(255,255,255,0.05))`;
}

function openModal(note){
  editingNote = note;
  modal.style.display = 'flex';
  taskText.value = note?.dataset.text || '';
  taskDeadline.value = note?.dataset.deadline || '';
  taskTags.value = note?.dataset.tags || '';
  taskComment.value = note?.dataset.comment || '';
}

function saveTask(){
  let note = editingNote || document.createElement('div');
  note.className='note'; note.draggable=true;
  note.dataset.text = taskText.value;
  note.dataset.deadline = taskDeadline.value;
  note.dataset.tags = taskTags.value;
  note.dataset.comment = taskComment.value;
  note.innerHTML = `
    <div>${taskText.value}</div>
    ${taskDeadline.value?`<div class="note-time">${new Date(taskDeadline.value).toLocaleString()}</div>`:''}
    <div class="tags">${renderTags(taskTags.value)}</div>
  `;
  note.onclick = e => { e.stopPropagation(); openModal(note); };
  note.ondragstart = () => draggedNote = note;
  note.ondragend = () => draggedNote = null;
  if(!editingNote) activeQuadrant.appendChild(note);
  updateNoteColor(note, activeQuadrant);
  closeModal();
}

function deleteTask(){ if(editingNote) editingNote.remove(); closeModal(); }
function renderTags(str){ return str.split(/[,#]/).filter(t=>t.trim()).map(t=>`<span class="tag">#${t.trim()}</span>`).join(''); }
function closeModal(){ modal.style.display='none'; editingNote=null; }

/* Pomodoro с корректным временем */
function startTimer(){
  clearInterval(timerInterval);
  let duration = (mode==='work'?parseInt(workTime.value):parseInt(restTime.value))*60;
  endTime = Date.now() + duration*1000;
  tick();
  timerInterval = setInterval(tick, 200); // обновляем каждые 200мс
}

function pauseTimer(){
  clearInterval(timerInterval);
  let remaining = Math.max(0, Math.round((endTime - Date.now())/1000));
  if(remaining>0) endTime = Date.now() + remaining*1000; // сохраняем оставшееся
}

function stopTimer(){
  clearInterval(timerInterval);
  endTime = 0;
  timer.textContent = (mode==='work'?workTime.value:restTime.value).padStart(2,'0') + ':00';
}

function setMode(m){
  mode = m;
  stopTimer();
}

function tick(){
  if(endTime<=0){
    let total = mode==='work'?parseInt(workTime.value)*60:parseInt(restTime.value)*60;
    let m = String(Math.floor(total/60)).padStart(2,'0');
    let s = String(total%60).padStart(2,'0');
    timer.textContent = `${m}:${s}`;
    return;
  }
  let remaining = Math.max(0, Math.round((endTime - Date.now())/1000));
  let m = String(Math.floor(remaining/60)).padStart(2,'0');
  let s = String(remaining%60).padStart(2,'0');
  timer.textContent = `${m}:${s}`;
  if(remaining <= 0){
    clearInterval(timerInterval);
    beep.play();
    notify(`Pomodoro завершен (${mode==='work'?'Работа':'Отдых'})`);
  }
}

/* Notifications */
if(Notification.permission!=="granted") Notification.requestPermission();
function notify(msg){
  if(Notification.permission==="granted") new Notification("Матрица Эйзенхауэра",{body:msg});
}
</script>
